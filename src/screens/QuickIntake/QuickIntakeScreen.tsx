import React, { useState, useEffect } from 'react'
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, Alert } from 'react-native'
import { SafeAreaView } from '@/shared/ui/SafeAreaView'
import { useTheme } from '@/app/providers/theme'
import { SPACING } from '@/shared/config'
import { FONT_SIZE } from '@/shared/config/constants/font'
import { databaseService } from '@/shared/lib/database'
import { Medicine, MedicineStock } from '@/entities/medicine/model/types'
import { MedicineKit } from '@/entities/kit/model/types'

export function QuickIntakeScreen() {
  const { colors } = useTheme()
  const [medicines, setMedicines] = useState<Medicine[]>([])
  const [stocks, setStocks] = useState<Map<string, MedicineStock>>(new Map())
  const [kits, setKits] = useState<Map<string, MedicineKit>>(new Map())
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    loadData()
  }, [])

  const loadData = async () => {
    try {
      setIsLoading(true)
      console.log('üîç Loading data for quick intake...')

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      console.log('üîß Checking database initialization...')
      await databaseService.init()
      console.log('‚úÖ Database initialized')

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∞–ø—Ç–µ—á–∫–∏
      console.log('üì¶ Loading kits...')
      const allKits = await databaseService.getKits()
      console.log('üì¶ Kits loaded:', allKits.length)
      const kitsMap = new Map(allKits.map(kit => [kit.id, kit]))
      setKits(kitsMap)

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
      console.log('üíä Loading medicines...')
      const allMedicines = await databaseService.getMedicines()
      console.log('üíä Medicines loaded:', allMedicines.length)
      setMedicines(allMedicines)

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∞—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
      console.log('üìã Loading stocks...')
      const stocksMap = new Map<string, MedicineStock>()

      for (const medicine of allMedicines) {
        try {
          const stock = await databaseService.getMedicineStock(medicine.id)
          if (stock) {
            stocksMap.set(medicine.id, stock)
          }
        } catch (error) {
          console.warn(`Failed to load stock for medicine ${medicine.id}:`, error)
        }
      }

      console.log('üìã Stocks loaded:', stocksMap.size)
      setStocks(stocksMap)

      console.log('‚úÖ Data loaded successfully')
    } catch (error) {
      console.error('‚ùå Failed to load data:', error)
      console.error('Error details:', {
        message: error.message,
        stack: error.stack,
        name: error.name
      })
      Alert.alert('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${error.message}`)
    } finally {
      setIsLoading(false)
    }
  }

  const handleIntake = async (medicine: Medicine) => {
    try {
      const stock = stocks.get(medicine.id)
      if (!stock) {
        Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ –Ω–∞–π–¥–µ–Ω –∑–∞–ø–∞—Å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞')
        return
      }

      if (stock.quantity <= 0) {
        Alert.alert('–í–Ω–∏–º–∞–Ω–∏–µ', '–õ–µ–∫–∞—Ä—Å—Ç–≤–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å')
        return
      }

      // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ 1
      const updatedStock = {
        ...stock,
        quantity: stock.quantity - 1,
        updatedAt: new Date(),
      }

      await databaseService.updateMedicineStock(stock.id, {
        quantity: updatedStock.quantity,
        updatedAt: updatedStock.updatedAt,
      })

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setStocks(prev => new Map(prev.set(medicine.id, updatedStock)))

      Alert.alert(
        '‚úÖ –ü—Ä–∏–µ–º –æ—Ç–º–µ—á–µ–Ω',
        `${medicine.name} –ø—Ä–∏–Ω—è—Ç —É—Å–ø–µ—à–Ω–æ!\n\n–û—Å—Ç–∞–ª–æ—Å—å: ${updatedStock.quantity} ${stock.unit}`
      )
    } catch (error) {
      console.error('Failed to mark intake:', error)
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–µ–º')
    }
  }

  const getKitName = (kitId: string) => {
    return kits.get(kitId)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∞–ø—Ç–µ—á–∫–∞'
  }

  const getStockInfo = (medicine: Medicine) => {
    const stock = stocks.get(medicine.id)
    if (!stock) {
      return { text: '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏', color: colors.error }
    }

    if (stock.quantity <= 0) {
      return { text: '–ó–∞–∫–æ–Ω—á–∏–ª–æ—Å—å', color: colors.error }
    }
    if (stock.quantity <= 5) {
      return { text: `${stock.quantity} ${stock.unit}`, color: colors.warning }
    }

    return { text: `${stock.quantity} ${stock.unit}`, color: colors.success }
  }

  if (isLoading) {
    return (
      <SafeAreaView style={[styles.container, { backgroundColor: colors.background }]}>
        <View style={styles.loadingContainer}>
          <Text style={[styles.loadingText, { color: colors.text }]}>
            –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤...
          </Text>
        </View>
      </SafeAreaView>
    )
  }

  // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–µ–º–∞
  const availableMedicines = medicines.filter(medicine => {
    const stock = stocks.get(medicine.id)
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ —Å –æ—Å—Ç–∞—Ç–∫–æ–º > 0
    return stock && stock.quantity > 0
  })

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∞–ø—Ç–µ—á–∫–∞–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  const medicinesByKit = availableMedicines.reduce((acc, medicine) => {
    const { kitId } = medicine
    if (!acc[kitId]) {
      acc[kitId] = []
    }
    acc[kitId].push(medicine)
    return acc
  }, {} as Record<string, Medicine[]>)

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: colors.background }]}>
      <ScrollView style={styles.scroll}>
        <View style={styles.header}>
          <Text style={[styles.title, { color: colors.text }]}>–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–∏–µ–º</Text>
          <Text style={[styles.subtitle, { color: colors.textSecondary }]}>
            –í—ã–±–µ—Ä–∏—Ç–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–∏–µ–º–∞
          </Text>
        </View>

        {availableMedicines.length === 0 ? (
          <View style={styles.emptyContainer}>
            <Text style={[styles.emptyTitle, { color: colors.text }]}>
              –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤
            </Text>
            <Text style={[styles.emptyDescription, { color: colors.textSecondary }]}>
              –í—Å–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∏–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∞–ø—Ç–µ—á–∫–∏
            </Text>
          </View>
        ) : (
          <View style={styles.medicinesList}>
            {Object.entries(medicinesByKit).map(([kitId, kitMedicines]) => {
              const kitName = getKitName(kitId)

              return (
                <View key={kitId} style={styles.kitSection}>
                  <Text style={[styles.kitTitle, { color: colors.text }]}>
                    üì¶ {kitName} ({kitMedicines.length})
                  </Text>

                  {kitMedicines.map(medicine => {
                    const stockInfo = getStockInfo(medicine)

                    return (
                      <TouchableOpacity
                        key={medicine.id}
                        style={[styles.medicineCard, { borderColor: colors.border }]}
                        onPress={() => handleIntake(medicine)}
                      >
                        <View style={styles.medicineContent}>
                          <View style={styles.medicineInfo}>
                            <Text style={[styles.medicineName, { color: colors.text }]}>
                              {medicine.name}
                            </Text>
                            <Text style={[styles.medicineForm, { color: colors.textSecondary }]}>
                              {medicine.form}
                            </Text>
                          </View>

                          <View style={styles.medicineRight}>
                            <View style={[styles.stockBadge, { backgroundColor: stockInfo.color }]}>
                              <Text style={styles.stockText}>{stockInfo.text}</Text>
                            </View>
                            <Text style={[styles.intakeButton, { color: colors.primary }]}>
                              –ü—Ä–∏–Ω—è—Ç—å
                            </Text>
                          </View>
                        </View>
                      </TouchableOpacity>
                    )
                  })}
                </View>
              )
            })}
          </View>
        )}

        <View style={styles.infoSection}>
          <Text style={[styles.infoTitle, { color: colors.text }]}>–û –±—ã—Å—Ç—Ä–æ–º –ø—Ä–∏–µ–º–µ</Text>
          <Text style={[styles.infoText, { color: colors.textSecondary }]}>
            ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏–µ–º{'\n'}
            ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–º–µ–Ω—å—à–∏—Ç—Å—è{'\n'}
            ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Å—Ç–∞—Ç–æ–∫ –ø–µ—Ä–µ–¥ –ø—Ä–∏–µ–º–æ–º
          </Text>
        </View>
      </ScrollView>
    </SafeAreaView>
  )
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  scroll: {
    flex: 1,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    fontSize: FONT_SIZE.md,
  },
  header: {
    padding: SPACING.md,
    paddingBottom: SPACING.sm,
  },
  title: {
    fontSize: FONT_SIZE.heading,
    fontWeight: 'bold',
    marginBottom: SPACING.sm,
  },
  subtitle: {
    fontSize: FONT_SIZE.md,
  },
  emptyContainer: {
    padding: SPACING.xl,
    alignItems: 'center',
  },
  emptyTitle: {
    fontSize: FONT_SIZE.lg,
    fontWeight: '600',
    marginBottom: SPACING.sm,
  },
  emptyDescription: {
    fontSize: FONT_SIZE.md,
    textAlign: 'center',
  },
  medicinesList: {
    paddingHorizontal: SPACING.md,
  },
  kitSection: {
    marginBottom: SPACING.lg,
  },
  kitTitle: {
    fontSize: FONT_SIZE.md,
    fontWeight: '600',
    marginBottom: SPACING.sm,
    paddingHorizontal: SPACING.sm,
  },
  medicineCard: {
    borderWidth: 1,
    borderRadius: 12,
    marginBottom: SPACING.md,
    backgroundColor: 'white',
  },
  medicineContent: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: SPACING.md,
  },
  medicineInfo: {
    flex: 1,
  },
  medicineName: {
    fontSize: FONT_SIZE.lg,
    fontWeight: '600',
    marginBottom: SPACING.xs,
  },
  medicineForm: {
    fontSize: FONT_SIZE.sm,
    marginBottom: SPACING.xs,
  },
  medicineKit: {
    fontSize: FONT_SIZE.sm,
  },
  medicineRight: {
    alignItems: 'flex-end',
  },
  stockBadge: {
    paddingHorizontal: SPACING.sm,
    paddingVertical: SPACING.xs,
    borderRadius: 8,
    marginBottom: SPACING.xs,
  },
  stockText: {
    color: 'white',
    fontSize: FONT_SIZE.sm,
    fontWeight: '600',
  },
  intakeButton: {
    fontSize: FONT_SIZE.sm,
    fontWeight: '600',
  },
  infoSection: {
    marginTop: SPACING.xl,
    paddingHorizontal: SPACING.md,
    paddingBottom: SPACING.md,
  },
  infoTitle: {
    fontSize: FONT_SIZE.md,
    fontWeight: '600',
    marginBottom: SPACING.sm,
  },
  infoText: {
    fontSize: FONT_SIZE.sm,
    lineHeight: 20,
  },
})
